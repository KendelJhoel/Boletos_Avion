@model List<Boletos_Avion.Models.Vuelo>

@{
    ViewData["Title"] = "Vuelos Filtrados";
    string filtro = ViewData["Filtro"]?.ToString() ?? "Categoría Desconocida";
}

<h2 class="text-center fw-bold mt-3">Vuelos filtrados por: @filtro</h2>

<!-- 🔹 Mensaje explicativo sobre el ordenamiento -->
<p class="text-center mt-3">
    <strong>📌 Nota:</strong> Puede hacer clic en cualquier columna para ordenar los datos.
    <br />
    Mantenga presionada la tecla <strong>Shift</strong> y haga clic en otra columna para aplicar ordenamiento combinado.
    <br />
    También puede hacer clic en cualquier fila para ver los detalles del vuelo.
</p>

@if (Model.Any())
{
    <div class="table-responsive mt-4">
        <table id="tablaVuelos" class="table table-bordered text-center" style="width:100%">
            <thead>
                <tr style="background-color: black; color: white;">
                    <th class="sortable">Ciudad Origen (Aeropuerto)</th>
                    <th class="sortable">Ciudad Destino (Aeropuerto)</th>
                    <th class="sortable">Aerolínea</th>
                    <th class="sortable">Salida</th>
                    <th class="sortable">Llegada</th>
                    <th class="sortable">Precio Base</th>
                    <th class="sortable">Estado</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var vuelo in Model)
                {
                    <tr class="clickable-row" data-href="@Url.Action("Detalle", "Vuelos", new { id = vuelo.IdVuelo })">
                        <td>@vuelo.CiudadOrigen (@vuelo.NombreAeropuertoOrigen)</td>
                        <td>@vuelo.CiudadDestino (@vuelo.NombreAeropuertoDestino)</td>
                        <td>@vuelo.NombreAerolinea</td>
                        <td>@vuelo.FechaSalida.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@vuelo.FechaLlegada.ToString("yyyy-MM-dd HH:mm")</td>
                        <td>$@vuelo.PrecioBase.ToString("N2")</td>
                        <td>@vuelo.Estado</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <p class="text-center text-danger mt-4">No hay vuelos disponibles para esta categoría adicional.</p>
}

@section Scripts {
    <style>
        table.dataTable thead th {
            position: relative;
            padding-right: 30px;
        }

            table.dataTable thead th::after {
                content: " ⬍"; /* 🔹 Flechitas de ordenamiento visibles siempre */
                position: absolute;
                right: 10px;
                color: white;
            }

        /* 🔹 Hacer que las filas sean clickeables y cambien de color al pasar el mouse */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

            .clickable-row:hover {
                background-color: #f8d7da;
            }
    </style>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

    <script>
        $(document).ready(function () {
            var tabla = $('#tablaVuelos').DataTable({
                "ordering": true,
                "paging": true,
                "pageLength": 25,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                "info": true,
                "searching": false,
                "orderMulti": true,
                "order": [],
                "autoWidth": false,
                "language": {
                    "lengthMenu": "Mostrar _MENU_ vuelos por página",
                    "zeroRecords": "No se encontraron vuelos",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ vuelos",
                    "infoEmpty": "No hay vuelos disponibles",
                    "infoFiltered": "(filtrado de _MAX_ vuelos en total)",
                    "paginate": {
                        "first": "Primero",
                        "last": "Último",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                }
            });

            // 🔹 Almacena el estado de cada columna (0 = Normal, 1 = Ascendente, 2 = Descendente)
            var estadoColumnas = {};

            $('#tablaVuelos thead th').on('click', function (event) {
                var index = $(this).index();

                if (!estadoColumnas[index]) {
                    estadoColumnas[index] = 0; // Estado normal al inicio
                }

                // 🔹 Alternamos entre los 3 estados: Normal (0), Ascendente (1), Descendente (2)
                estadoColumnas[index] = (estadoColumnas[index] + 1) % 3;

                // 🔹 Obtener el orden actual de la tabla
                var ordenActual = tabla.order();

                // Si no se presiona Shift, limpiar todas las otras ordenaciones y solo usar la columna actual
                if (!event.shiftKey) {
                    estadoColumnas = { [index]: estadoColumnas[index] }; // Resetear solo la columna actual
                    ordenActual = [];
                }

                // 🔹 Si el estado es Normal (0), eliminamos la columna del orden activo
                if (estadoColumnas[index] === 0) {
                    ordenActual = ordenActual.filter(o => o[0] !== index);
                }
                // 🔼 Si el estado es Ascendente (1), agregamos la columna en orden Ascendente
                else if (estadoColumnas[index] === 1) {
                    ordenActual = ordenActual.filter(o => o[0] !== index); // Quitar la anterior
                    ordenActual.push([index, 'asc']);
                }
                // 🔽 Si el estado es Descendente (2), agregamos la columna en orden Descendente
                else {
                    ordenActual = ordenActual.filter(o => o[0] !== index); // Quitar la anterior
                    ordenActual.push([index, 'desc']);
                }

                // 🔹 Aplicar los nuevos ordenamientos
                tabla.order(ordenActual).draw();
            });

            // 🔹 Evento Click en la Fila para redirigir a Detalle sin interferir con el ordenamiento
            $('#tablaVuelos tbody').on("click", "tr", function () {
                var url = $(this).data("href");
                if (url) {
                    window.location.href = url;
                }
            });
        });
    </script>

}
